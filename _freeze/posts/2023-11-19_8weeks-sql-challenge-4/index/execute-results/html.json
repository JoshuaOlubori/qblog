{
  "hash": "6d38381fa1f603c3127ac49aea87722c",
  "result": {
    "markdown": "---\ntitle: \"Data Bank\"\nsubtitle: \"Fourth part of a series of SQL case studies... more CTEs!\"\nauthor: \"Edun Joshua\"\ndate: \"2023-11-19\"\ncategories: [sql]\nimage: \"image.PNG\"\n---\n\n\n::: {style=\"color: #25D366;\"}\n## Introduction\n:::\n\nData Bank runs just like any other digital bank - but with a distributed data storage platform. Customers are allocated cloud data storage limits which are directly linked to how much money they have in their accounts. The management team at Data Bank want to increase their total customer base - but also need some help tracking just how much data storage their customers will need. This case study is all about calculating metrics, growth and helping the business analyse their data in a smart way to better forecast and plan for their future developments!\n\n::: {style=\"color: #25D366;\"}\n## Entity Relationship Diagram\n:::\n\n![](images/databank.jpg)\n\n::: {style=\"color: #25D366;\"}\n## Database Connection\n:::\n\nFirst, I'll create a connection to my local `postgres` database thanks to the **`RPostgres`** package.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# | warning: false\n# Creating a connection to my local postgres database\nlibrary(RPostgres)\ncon <-\n  dbConnect(Postgres(),\n            dbname = \"data_bank\",\n            user = \"postgres\",\n            password = my_password)\n```\n:::\n\n\n::: {style=\"color: #25D366\"}\n## Queries\n:::\n\n### A. Customer Nodes Exploration\n\n#### 1. How many unique nodes are there on the Data Bank system?\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect count(DISTINCT node_id) as unique_nodes\nfrom customer_nodes;\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 1 records\n\n| unique_nodes|\n|------------:|\n|            5|\n\n</div>\n:::\n\n\n#### 2. What is the number of nodes per region?\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect region_id,\n    count(DISTINCT node_id) as nodes_per_region\nfrom customer_nodes\nGROUP BY region_id;\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 5 records\n\n|region_id | nodes_per_region|\n|:---------|----------------:|\n|1         |                5|\n|2         |                5|\n|3         |                5|\n|4         |                5|\n|5         |                5|\n\n</div>\n:::\n\n\n#### 3. How many customers are allocated to each region?\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect r.region_name,\n    count(distinct cn.customer_id) as customers_per_region\nfrom customer_nodes cn\n    natural JOIN regions r\nGROUP BY region_name;\n\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 5 records\n\n|region_name | customers_per_region|\n|:-----------|--------------------:|\n|Africa      |                  102|\n|America     |                  105|\n|Asia        |                   95|\n|Australia   |                  110|\n|Europe      |                   88|\n\n</div>\n:::\n\n\n#### 4. How many days on average are customers reallocated to a different node?\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nwith cte1 as(\n    select customer_id,\n        node_id,\n        lead(node_id) over(\n            partition by customer_id\n            order by start_date\n        ) as lead_node,\n        start_date,\n        lead(start_date) over(\n            partition by customer_id\n            order by start_date\n        ) as lead_date\n    from customer_nodes\n),\ncte2 as (\n    select lead_date - start_date as days_btw_next_node\n    from cte1\n)\nselect round(avg(days_btw_next_node)::numeric, 2) as average_reallocation_period\nfrom cte2;\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 1 records\n\n| average_reallocation_period|\n|---------------------------:|\n|                       15.63|\n\n</div>\n:::\n\n\n#### 5. What is the median, 80th and 95th percentile for this same reallocation days metric for each region?\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nwith cte1 as(\n    select customer_id,\n        region_id,\n        node_id,\n        lead(node_id) over(\n            partition by customer_id\n            order by start_date\n        ) as lead_node,\n        start_date,\n        lead(start_date) over(\n            partition by customer_id\n            order by start_date\n        ) as lead_date\n    from customer_nodes\n),\ncte2 as(\n    select *,\n        lead_date - start_date as days_btw_next_node\n    from cte1\n)\nselect region_id,\n    percentile_disc (0.5) within group (\n        order by days_btw_next_node\n    ) as median_realloc_metric,\n    percentile_disc (0.8) within group (\n        order by days_btw_next_node\n    ) as pctile_80_realloc_metric,\n    percentile_disc (0.95) within group (\n        order by days_btw_next_node\n    ) as pctile_95_realloc_metric\nfrom cte2\nGROUP BY 1;\n\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 5 records\n\n|region_id | median_realloc_metric| pctile_80_realloc_metric| pctile_95_realloc_metric|\n|:---------|---------------------:|------------------------:|------------------------:|\n|1         |                    16|                       24|                       29|\n|2         |                    16|                       24|                       29|\n|3         |                    16|                       25|                       29|\n|4         |                    16|                       24|                       29|\n|5         |                    16|                       25|                       29|\n\n</div>\n:::\n\n\n### B. Customer Transactions\n\n#### 1. What is the unique count and total amount for each transaction type?\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect txn_type as transaction_type, count(distinct (customer_id, txn_date, txn_amount, txn_amount)) as txn_dcount, sum(txn_amount) as txn_amount_sum\nfrom customer_transactions\ngroup by 1;\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 3 records\n\n|transaction_type | txn_dcount| txn_amount_sum|\n|:----------------|----------:|--------------:|\n|deposit          |       2671|        1359168|\n|purchase         |       1617|         806537|\n|withdrawal       |       1580|         793003|\n\n</div>\n:::\n\n\n#### 2. What is the average total historical deposit counts and amounts for all customers?\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect avg(txn_amount) as avg_historical_deposit_counts ,count(txn_type) as deposit_counts\nfrom customer_transactions\nwhere txn_type = 'deposit';\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 1 records\n\n| avg_historical_deposit_counts| deposit_counts|\n|-----------------------------:|--------------:|\n|                      508.8611|           2671|\n\n</div>\n:::\n\n\n### Closing the connection\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndbDisconnect(con)\n```\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}