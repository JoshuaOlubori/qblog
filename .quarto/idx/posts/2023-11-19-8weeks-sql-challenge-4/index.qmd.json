{"title":"Data Bank","markdown":{"yaml":{"title":"Data Bank","subtitle":"Fourth part of a series of SQL case studies... more CTEs!","author":"Edun Joshua","date":"2023-11-19","categories":["sql"],"image":"image.jpg"},"headingText":"Introduction","containsRefs":false,"markdown":"\n\n::: {style=\"color: #25D366;\"}\n:::\n\nData Bank runs just like any other digital bank - but with a distributed data storage platform. Customers are allocated cloud data storage limits which are directly linked to how much money they have in their accounts. The management team at Data Bank want to increase their total customer base - but also need some help tracking just how much data storage their customers will need. This case study is all about calculating metrics, growth and helping the business analyse their data in a smart way to better forecast and plan for their future developments!\n\n::: {style=\"color: #25D366;\"}\n## Entity Relationship Diagram\n:::\n\n![](images/databank.jpg)\n\n::: {style=\"color: #25D366;\"}\n## Database Connection\n:::\n\nFirst, I'll create a connection to my local `postgres` database thanks to the **`RPostgres`** package.\n\n```{r,echo=FALSE}\nmy_password <- \"pluto\"\n\n```\n\n```{r}\n# | warning: false\n# Creating a connection to my local postgres database\nlibrary(RPostgres)\ncon <-\n  dbConnect(Postgres(),\n            dbname = \"data_bank\",\n            user = \"postgres\",\n            password = my_password)\n\n\n```\n\n::: {style=\"color: #25D366\"}\n## Queries\n:::\n\n### A. Customer Nodes Exploration\n\n#### 1. How many unique nodes are there on the Data Bank system?\n\n```{sql connection=con}\nselect count(DISTINCT node_id) as unique_nodes\nfrom customer_nodes;\n```\n\n#### 2. What is the number of nodes per region?\n\n```{sql connection=con}\nselect region_id,\n    count(DISTINCT node_id) as nodes_per_region\nfrom customer_nodes\nGROUP BY region_id;\n```\n\n#### 3. How many customers are allocated to each region?\n\n```{sql connection=con}\nselect r.region_name,\n    count(distinct cn.customer_id) as customers_per_region\nfrom customer_nodes cn\n    natural JOIN regions r\nGROUP BY region_name;\n\n```\n\n#### 4. How many days on average are customers reallocated to a different node?\n\n```{sql connection=con}\nwith cte1 as(\n    select customer_id,\n        node_id,\n        lead(node_id) over(\n            partition by customer_id\n            order by start_date\n        ) as lead_node,\n        start_date,\n        lead(start_date) over(\n            partition by customer_id\n            order by start_date\n        ) as lead_date\n    from customer_nodes\n),\ncte2 as (\n    select lead_date - start_date as days_btw_next_node\n    from cte1\n)\nselect round(avg(days_btw_next_node)::numeric, 2) as average_reallocation_period\nfrom cte2;\n```\n\n#### 5. What is the median, 80th and 95th percentile for this same reallocation days metric for each region?\n\n```{sql connection=con}\nwith cte1 as(\n    select customer_id,\n        region_id,\n        node_id,\n        lead(node_id) over(\n            partition by customer_id\n            order by start_date\n        ) as lead_node,\n        start_date,\n        lead(start_date) over(\n            partition by customer_id\n            order by start_date\n        ) as lead_date\n    from customer_nodes\n),\ncte2 as(\n    select *,\n        lead_date - start_date as days_btw_next_node\n    from cte1\n)\nselect region_id,\n    percentile_disc (0.5) within group (\n        order by days_btw_next_node\n    ) as median_realloc_metric,\n    percentile_disc (0.8) within group (\n        order by days_btw_next_node\n    ) as pctile_80_realloc_metric,\n    percentile_disc (0.95) within group (\n        order by days_btw_next_node\n    ) as pctile_95_realloc_metric\nfrom cte2\nGROUP BY 1;\n\n```\n\n### B. Customer Transactions\n\n#### 1. What is the unique count and total amount for each transaction type?\n\n```{sql connection=con}\nselect txn_type as transaction_type, count(distinct (customer_id, txn_date, txn_amount, txn_amount)) as txn_dcount, sum(txn_amount) as txn_amount_sum\nfrom customer_transactions\ngroup by 1;\n```\n\n#### 2. What is the average total historical deposit counts and amounts for all customers?\n\n```{sql connection=con}\nselect avg(txn_amount) as avg_historical_deposit_counts ,count(txn_type) as deposit_counts\nfrom customer_transactions\nwhere txn_type = 'deposit';\n```\n\n### Closing the connection\n\n```{r}\ndbDisconnect(con)\n```","srcMarkdownNoYaml":"\n\n::: {style=\"color: #25D366;\"}\n## Introduction\n:::\n\nData Bank runs just like any other digital bank - but with a distributed data storage platform. Customers are allocated cloud data storage limits which are directly linked to how much money they have in their accounts. The management team at Data Bank want to increase their total customer base - but also need some help tracking just how much data storage their customers will need. This case study is all about calculating metrics, growth and helping the business analyse their data in a smart way to better forecast and plan for their future developments!\n\n::: {style=\"color: #25D366;\"}\n## Entity Relationship Diagram\n:::\n\n![](images/databank.jpg)\n\n::: {style=\"color: #25D366;\"}\n## Database Connection\n:::\n\nFirst, I'll create a connection to my local `postgres` database thanks to the **`RPostgres`** package.\n\n```{r,echo=FALSE}\nmy_password <- \"pluto\"\n\n```\n\n```{r}\n# | warning: false\n# Creating a connection to my local postgres database\nlibrary(RPostgres)\ncon <-\n  dbConnect(Postgres(),\n            dbname = \"data_bank\",\n            user = \"postgres\",\n            password = my_password)\n\n\n```\n\n::: {style=\"color: #25D366\"}\n## Queries\n:::\n\n### A. Customer Nodes Exploration\n\n#### 1. How many unique nodes are there on the Data Bank system?\n\n```{sql connection=con}\nselect count(DISTINCT node_id) as unique_nodes\nfrom customer_nodes;\n```\n\n#### 2. What is the number of nodes per region?\n\n```{sql connection=con}\nselect region_id,\n    count(DISTINCT node_id) as nodes_per_region\nfrom customer_nodes\nGROUP BY region_id;\n```\n\n#### 3. How many customers are allocated to each region?\n\n```{sql connection=con}\nselect r.region_name,\n    count(distinct cn.customer_id) as customers_per_region\nfrom customer_nodes cn\n    natural JOIN regions r\nGROUP BY region_name;\n\n```\n\n#### 4. How many days on average are customers reallocated to a different node?\n\n```{sql connection=con}\nwith cte1 as(\n    select customer_id,\n        node_id,\n        lead(node_id) over(\n            partition by customer_id\n            order by start_date\n        ) as lead_node,\n        start_date,\n        lead(start_date) over(\n            partition by customer_id\n            order by start_date\n        ) as lead_date\n    from customer_nodes\n),\ncte2 as (\n    select lead_date - start_date as days_btw_next_node\n    from cte1\n)\nselect round(avg(days_btw_next_node)::numeric, 2) as average_reallocation_period\nfrom cte2;\n```\n\n#### 5. What is the median, 80th and 95th percentile for this same reallocation days metric for each region?\n\n```{sql connection=con}\nwith cte1 as(\n    select customer_id,\n        region_id,\n        node_id,\n        lead(node_id) over(\n            partition by customer_id\n            order by start_date\n        ) as lead_node,\n        start_date,\n        lead(start_date) over(\n            partition by customer_id\n            order by start_date\n        ) as lead_date\n    from customer_nodes\n),\ncte2 as(\n    select *,\n        lead_date - start_date as days_btw_next_node\n    from cte1\n)\nselect region_id,\n    percentile_disc (0.5) within group (\n        order by days_btw_next_node\n    ) as median_realloc_metric,\n    percentile_disc (0.8) within group (\n        order by days_btw_next_node\n    ) as pctile_80_realloc_metric,\n    percentile_disc (0.95) within group (\n        order by days_btw_next_node\n    ) as pctile_95_realloc_metric\nfrom cte2\nGROUP BY 1;\n\n```\n\n### B. Customer Transactions\n\n#### 1. What is the unique count and total amount for each transaction type?\n\n```{sql connection=con}\nselect txn_type as transaction_type, count(distinct (customer_id, txn_date, txn_amount, txn_amount)) as txn_dcount, sum(txn_amount) as txn_amount_sum\nfrom customer_transactions\ngroup by 1;\n```\n\n#### 2. What is the average total historical deposit counts and amounts for all customers?\n\n```{sql connection=con}\nselect avg(txn_amount) as avg_historical_deposit_counts ,count(txn_type) as deposit_counts\nfrom customer_transactions\nwhere txn_type = 'deposit';\n```\n\n### Closing the connection\n\n```{r}\ndbDisconnect(con)\n```"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":true,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":true,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"css":["../../styles.css"],"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.450","smooth-scroll":true,"theme":{"light":"journal","dark":"darkly"},"citations-hover":true,"footnotes-hover":true,"title-block-banner":true,"title":"Data Bank","subtitle":"Fourth part of a series of SQL case studies... more CTEs!","author":"Edun Joshua","date":"2023-11-19","categories":["sql"],"image":"image.jpg"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}